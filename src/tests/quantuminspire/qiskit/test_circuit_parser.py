import unittest
from unittest.mock import Mock

import numpy as np
import qiskit
from qiskit import QuantumRegister, ClassicalRegister, QuantumCircuit

from quantuminspire.qiskit.backend_qx import QuantumInspireBackend


class TestQiCircuitToString(unittest.TestCase):

    def test_generate_cqasm_WithEntangleAlgorithm(self):
        q = QuantumRegister(2)
        b = ClassicalRegister(2)
        circuit = QuantumCircuit(q, b)

        circuit.h(q[0])
        circuit.cx(q[0], q[1])
        circuit.measure(q[0], b[0])
        circuit.measure(q[1], b[1])

        simulator = QuantumInspireBackend(Mock(), Mock())
        qiskit_job = qiskit.compile(circuit, simulator)
        experiment = qiskit_job.experiments[0]
        result = simulator._generate_cqasm(experiment)
        expected = "version 1.0\n" \
                   "# cqasm generated by QI backend for QisKit\n" \
                   "qubits 2\n" \
                   "H q[0]\n" \
                   "CNOT q[0], q[1]\n"
        self.assertEqual(result, expected)

    @staticmethod
    def _generate_cqasm_from_instructions(instructions, number_of_qubits=2):
        experiment_dict = {'instructions': None,
                           'header': {'number_of_qubits': number_of_qubits,
                                      'number_of_clbits': number_of_qubits,
                                      'compiled_circuit_qasm': ''},
                           'config': {'coupling_map': 'all-to-all',
                                      'basis_gates': 'x,y,z,h,s,cx,ccx,u1,u2,u3,id,snapshot',
                                      'n_qubits': number_of_qubits}}

        experiment_dict['instructions'] = instructions
        experiment = qiskit.qobj.QobjExperiment.from_dict(experiment_dict)

        simulator = QuantumInspireBackend(Mock(), Mock())
        result = simulator._generate_cqasm(experiment)
        return result

    def test_generate_cqasm_CorrectOutputControlledNot(self):
        instructions = [{'name': 'cx', 'qubits': [0, 1]}]
        result = self._generate_cqasm_from_instructions(instructions, 2)
        self.assertTrue('CNOT q[0], q[1]\n' in result)

    def test_generate_cqasm_CorrectOutputToffoli(self):
        instructions = [{'name': 'ccx', 'qubits': [0, 1, 2]}]
        result = self._generate_cqasm_from_instructions(instructions, number_of_qubits=3)
        self.assertTrue('Toffoli q[0], q[1], q[2]\n' in result)

    def test_generate_cqasm_CorrectOutputMeasure(self):
        instructions = [{'name': 'measure', 'qubits': [0]}]
        result = self._generate_cqasm_from_instructions(instructions, 3)
        measure_line = '.measurement\n   measure q[0]\n   measure q[1]\n   measure q[2]\n'
        self.assertTrue(measure_line not in result)

    def test_generate_cqasm_CorrectOutputHadamard(self):
        instructions = [{'name': 'h', 'qubits': [0]}]
        result = self._generate_cqasm_from_instructions(instructions, 2)
        self.assertTrue('H q[0]\n' in result)

    def test_generate_cqasm_CorrectOutputBarrier(self):
        instructions = [{'name': 'barrier', 'qubits': [0]}]
        result = self._generate_cqasm_from_instructions(instructions, 2)
        self.assertFalse('barrier' in result)

    def test_generate_cqasm_CorrectOutputIdentity(self):
        instructions = [{'name': 'id', 'qubits': [0]}]
        result = self._generate_cqasm_from_instructions(instructions, 2)

        self.assertFalse('id' in result)

    def test_generate_cqasm_CorrectOutputGateX(self):
        instructions = [{'name': 'x', 'qubits': [0]}]
        result = self._generate_cqasm_from_instructions(instructions, 2)

        self.assertTrue('X q[0]\n' in result)

    def test_generate_cqasm_CorrectOutputGateY(self):
        instructions = [{'name': 'y', 'qubits': [0]}]
        result = self._generate_cqasm_from_instructions(instructions, 2)

        self.assertTrue('Y q[0]\n' in result)

    def test_generate_cqasm_CorrectOutputGateZ(self):
        instructions = [{'name': 'z', 'qubits': [0]}]
        result = self._generate_cqasm_from_instructions(instructions, 2)

        self.assertTrue('Z q[0]\n' in result)

    def test_generate_cqasm_CorrectOutputGateU(self):
        instructions = [{'name': 'u', 'qubits': [0], 'params': [0, 0, np.pi / 2]}]
        result = self._generate_cqasm_from_instructions(instructions, 2)

        self.assertTrue('S q[0]\n' in result)

        instructions = [{'name': 'u', 'qubits': [0], 'params': [0, 0, -np.pi / 2]}]
        result = self._generate_cqasm_from_instructions(instructions, 2)

        self.assertTrue('Sdag q[0]\n' in result)

    def test_generate_cqasm_RaisesErrorGateU(self):
        instructions = [{'name': 'u', 'qubits': [0], 'params': [0, 0, 0]}]

        self.assertRaises(ValueError, self._generate_cqasm_from_instructions, instructions)

    def test_generate_cqasm_CorrectOutputGateU0(self):
        instructions = [{'name': 'u0', 'qubits': [0]}]
        result = self._generate_cqasm_from_instructions(instructions, 2)

        self.assertFalse('U0' in result)

    def test_generate_cqasm_CorrectOutputGateU1(self):
        instructions = [{'name': 'u1', 'qubits': [0], 'params': [np.pi / 2]}]
        result = self._generate_cqasm_from_instructions(instructions, 2)

        self.assertTrue('S q[0]\n' in result)

        instructions = [{'name': 'u1', 'qubits': [1], 'params': [np.pi / 4]}]
        result = self._generate_cqasm_from_instructions(instructions, 2)
        self.assertTrue('T q[1]\n' in result)

        instructions = [{'name': 'u1', 'qubits': [2], 'params': [-np.pi / 4]}]
        result = self._generate_cqasm_from_instructions(instructions, 2)
        self.assertTrue('Tdag q[2]\n' in result)

    def test_generate_cqasm_RaisesErrorGateU1(self):
        instructions = [{'name': 'u1', 'qubits': [2], 'params': [42]}]

        self.assertRaises(ValueError, self._generate_cqasm_from_instructions, instructions)

    def test_generate_cqasm_CorrectOutputGateU2(self):
        instructions = [{'name': 'u2', 'qubits': [0], 'params': [np.pi]}]
        self.assertRaises(ValueError, self._generate_cqasm_from_instructions, instructions)

    def test_generate_cqasm_CorrectoutputU3(self):
        instructions = [{'name': 'u3', 'qubits': [0], 'params': [1, 2, 3]}]
        result = self._generate_cqasm_from_instructions(instructions, 2)
        self.assertTrue('Rz q[0], 1.000000\nRy q[0], 2.000000\nRz q[0], 3.000000\n' in result)
